# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**tcs.core** is a PowerShell module providing core utility functions (configuration management, dynamic parameter creation, telemetry, string utilities) for the TheCodeSaiyan PowerShell module suite. Published to the PowerShell Gallery. Requires PowerShell 5.1+ (Desktop & Core editions).

## Build & Test Commands

```powershell
# Validate module (manifest + PSScriptAnalyzer)
.\Build.ps1 -Task Validate

# Run all tests (validation + PSScriptAnalyzer + function tests)
.\Build.ps1 -Task Test

# Run Pester tests directly for a specific function
Invoke-Pester -Path "modules/tcs.core/Private/Tests/Get-ModuleConfig.Tests.ps1" -Output Detailed
Invoke-Pester -Path "modules/tcs.core/Public/Tests/Set-ModuleConfig.Tests.ps1" -Output Detailed

# Run smoke tests (preferred for quick local validation; avoids Build.ps1 path bug)
pwsh -File .github/scripts/module-smoke-tests.ps1

# Update module version
.\Build.ps1 -Task UpdateVersion -Version "x.y.z"

# Prepare release (version update + validation + tests)
.\Build.ps1 -Task PrepareRelease -Version "x.y.z"

# Import module locally for manual testing
Import-Module .\modules\tcs.core\tcs.core.psd1 -Force
```

## Architecture

### Module Layout

- `modules/tcs.core/tcs.core.psd1` - Module manifest (version, exports, metadata)
- `modules/tcs.core/tcs.core.psm1` - Root module; dot-sources all `.ps1` files from `Public/` and `Private/`, initializes config, exports functions
- `modules/tcs.core/Public/` - Exported functions (ConvertTo-CamelCase, ConvertTo-HashTable, ConvertTo-KebabCase, ConvertTo-PascalCase, ConvertTo-SnakeCase, Invoke-WithRetry, New-DynamicParameter, New-TemporaryDirectory, Protect-ConfigValue, Set-ModuleConfig, Test-IsElevated, Unprotect-ConfigValue, Write-Log)
- `modules/tcs.core/Private/` - Internal functions also exported cross-module (Get-ModuleConfig, Get-ModuleStatus, Get-ParameterValues, Invoke-TelemetryCollection)
- `modules/tcs.core/Config/Module.Defaults.json` - Default configuration values

### Function/Test Convention

Each function lives in its own `.ps1` file. Tests are colocated in a `Tests/` subdirectory with the naming pattern `FunctionName.Tests.ps1`. Test files follow a standard template that:
1. Dot-sources the function under test (derived from the test filename)
2. Runs functional tests in a `Describe` block
3. Runs PSScriptAnalyzer compliance tests against each rule

PSScriptAnalyzer settings: Severity=Error,Warning (see `Tests/PSScriptAnalyzerSettings.psd1`).

### Module Load Sequence (tcs.core.psm1)

1. Discover and dot-source all `Public/*.ps1` and `Private/*.ps1` (excluding `*.Tests.ps1`)
2. Initialize config via `Get-ModuleConfig` using `$PSCommandPath`
3. Check for updates via `Get-ModuleStatus` if `UpdateWarning` is enabled
4. Export public functions + selected private functions (Invoke-TelemetryCollection, Get-ModuleConfig, Get-ModuleStatus, Get-ParameterValues)

### Configuration System

User config stored at `$env:AppData\PowerShell\Config\tcs.core\Module.Config.json`. Defaults come from `Config/Module.Defaults.json`. Config is merged at load time and updated via `Set-ModuleConfig`.

## CI/CD Pipeline (GitHub Actions)

Workflow chain: **Push/PR** -> `ci-validate.yml` -> on success -> `create-version-tag.yml` + `generate-docs.yml`; **Tag push (v*)** -> `publish-to-psgallery.yml`.

All workflows use reusable workflows from the `tcs-shared-workflows` repository. CI runs smoke tests from `.github/scripts/module-smoke-tests.ps1`.

### Releasing a New Version

1. Update `ModuleVersion` in `modules/tcs.core/tcs.core.psd1`
2. Update `FunctionsToExport` in the manifest if adding new public functions
3. Push to main; CI validates, auto-creates a version tag, then publishes to PSGallery

## Code Style

- Follow PowerShell approved verbs (`Get-Verb` to list) for function names
- Use `[CmdletBinding()]` and `param()` blocks on all functions
- Use `[Parameter()]` attributes with `Mandatory`, `ValueFromPipeline`, `HelpMessage` as appropriate
- Private functions not in the manifest's `FunctionsToExport` are still explicitly exported in `tcs.core.psm1` line 35 — update both places if adding private functions meant for cross-module use
- Version format is strict semver `x.y.z` — no pre-release suffixes

## Environment Notes

- Windows-targeted module — telemetry functions use WMI classes (Win32_ComputerSystem, Win32_OperatingSystem, etc.)
- `docs/` directory is auto-generated by PlatyPS via CI — do not manually edit
- Shared workflow repo at `d:\git\tcs-shared-workflows` (available as additional working directory)

## Adding a New Function

1. Create `modules/tcs.core/Public/FunctionName.ps1` (or `Private/` for internal)
2. Include comment-based help with `.SYNOPSIS`, `.DESCRIPTION`, `.PARAMETER`, `.EXAMPLE`
3. Create `modules/tcs.core/Public/Tests/FunctionName.Tests.ps1` using the existing test template
4. If public: add the function name to `FunctionsToExport` in `tcs.core.psd1`
5. The `.psm1` auto-discovers and dot-sources new `.ps1` files; no changes needed there
